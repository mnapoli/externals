#!/usr/bin/env php
<?php
declare(strict_types = 1);

use Externals\Application\Application;
use Externals\Application\Command\InitCommand;
use Externals\Domain\Command\Handler\ReceiveEmailHandler;
use Externals\Domain\Command\ReceiveEmail;
use Externals\Domain\Email\EmailContentParser;
use Externals\Domain\Email\EmailRepository;
use Imapi\Client;
use Imapi\Query\QueryBuilder;
use Symfony\Bridge\Monolog\Handler\ConsoleHandler;
use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Console\Output\OutputInterface;

require_once __DIR__ . '/vendor/autoload.php';
require_once __DIR__ . '/.puli/GeneratedPuliFactory.php';

$application = new Application;
$cli = $application->cli();

$cli->command('init', InitCommand::class);

$cli->command('sync [days]', function (int $days = null, Client $imapClient, ReceiveEmailHandler $receiveEmailHandler, OutputInterface $output) {
    $days = $days ?? 1;
    $query = QueryBuilder::create('INBOX')
        ->youngerThan(3600 * 24 * $days)
        ->getQuery();
    $emailIds = $imapClient->getEmailIds($query);

    $output->writeln(sprintf('<comment>%d emails to synchronize</comment>', count($emailIds)));

    foreach ($emailIds as $emailId) {
        $receiveEmailHandler(new ReceiveEmail((string) $emailId));
    }
});

$cli->command('reparse', function (EmailRepository $emailRepository, EmailContentParser $contentParser) {
    foreach ($emailRepository->findAll() as $email) {
        $newContent = $contentParser->parse($email->getOriginalContent());
        $email->setContent($newContent);
        $emailRepository->update($email);
    }
});

$output = new ConsoleOutput();
$application->getContainer()->get(ConsoleHandler::class)->setOutput($output);
$cli->run(null, $output);
